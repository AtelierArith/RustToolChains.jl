name: Bump Rust stable toolchain

on:
  schedule:
    - cron: "0 0 * * 1"  # æ¯é€±æœˆæ›œæ—¥ 00:00 UTC
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) README ã‹ã‚‰ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
      - name: Get current version from README
        id: current
        shell: bash
        run: |
          set -euo pipefail
          current_ver="$(grep -E 'ğŸ¦€ Provides Rust [0-9]+\.[0-9]+\.[0-9]+ toolchain' README.md | sed -E 's/.*Provides Rust ([0-9]+\.[0-9]+\.[0-9]+).*/\1/')"
          echo "version=$current_ver" >> "$GITHUB_OUTPUT"
          echo "Current version in README: $current_ver"

      # 2) æœ€æ–° stable ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
      - name: Get latest Rust stable version
        id: rust
        shell: bash
        run: |
          set -euo pipefail
          TOML_URL="https://static.rust-lang.org/dist/channel-rust-stable.toml"
          ver="$(curl -fsSL "$TOML_URL" | grep -A1 '^\[pkg\.rust\]' | grep 'version = ' | sed -E 's/version = "([0-9]+\.[0-9]+\.[0-9]+).*/\1/')"
          echo "version=$ver" >> "$GITHUB_OUTPUT"
          echo "Latest stable: $ver"

      # 3) ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¯”è¼ƒã—ã¦ã‚¹ã‚­ãƒƒãƒ—åˆ¤å®š
      - name: Check if update is needed
        id: check
        shell: bash
        run: |
          set -euo pipefail
          current="${{ steps.current.outputs.version }}"
          latest="${{ steps.rust.outputs.version }}"
          if [ "$current" = "$latest" ]; then
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            echo "âœ… Already up to date ($current)"
          else
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ“¦ Update needed: $current -> $latest"
          fi

      # 4) Julia ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¿…è¦æ™‚ã®ã¿ï¼‰
      - uses: julia-actions/setup-julia@v2
        if: steps.check.outputs.needs_update == 'true'
        with:
          version: "1"

      # 5) Artifacts.toml ã‚’ç”Ÿæˆï¼ˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¿…è¦æ™‚ã®ã¿ï¼‰
      - name: Regenerate Artifacts.toml
        if: steps.check.outputs.needs_update == 'true'
        run: |
          julia --project=gen -e 'using Pkg; Pkg.instantiate()'
          julia --project=gen gen/generate_Artifacts_toml.jl "${{ steps.rust.outputs.version }}"

      # 6) README ã® "Provides Rust X.Y.Z" ã‚‚æ›´æ–°ï¼ˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¿…è¦æ™‚ã®ã¿ï¼‰
      - name: Update README version line
        if: steps.check.outputs.needs_update == 'true'
        shell: bash
        run: |
          set -euo pipefail
          v="${{ steps.rust.outputs.version }}"
          # README ã« "Provides Rust 1.92.0 toolchain" ã¿ãŸã„ãªè¡ŒãŒã‚ã‚‹å‰æ
          sed -i -E "s/Provides Rust [0-9]+\.[0-9]+\.[0-9]+ toolchain/Provides Rust ${v} toolchain/" README.md || true

      # 7) å·®åˆ†ãŒç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼ˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¿…è¦æ™‚ã®ã¿ï¼‰
      - name: Check diff
        if: steps.check.outputs.needs_update == 'true'
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      # 8) å¤‰æ›´ãŒã‚ã‚Œã° PR ä½œæˆ
      - name: Create pull request
        if: steps.check.outputs.needs_update == 'true' && steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          branch: bump-rust-stable-${{ steps.rust.outputs.version }}
          title: "Bump Rust stable toolchain to ${{ steps.rust.outputs.version }}"
          body: |
            This PR updates RustToolChains.jl to the latest Rust stable toolchain (${{
              steps.rust.outputs.version
            }}), regenerating Artifacts.toml via gen/generate_Artifacts_toml.jl.
          commit-message: "Bump Rust stable toolchain to ${{ steps.rust.outputs.version }}"
          labels: automated
